{% extends "layouts/base.html" %}

{% block page_title %}Tổng quan bảo trì{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('maintenance_list') }}">Bảo trì</a></li>
<li class="breadcrumb-item active">Tổng quan</li>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-chart-line mr-2"></i>Tổng quan bảo trì thiết bị IT</h3>
        <div class="card-tools">
          <span class="badge badge-primary">Năm {{ year }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- KPI Cards Row 1: Tổng quan năm -->
<div class="row mb-3">
  <div class="col-12">
    <h5 class="mb-2"><i class="fas fa-calendar-alt text-primary mr-2"></i>Thống kê năm {{ year }}</h5>
  </div>
</div>
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="small-box bg-info">
      <div class="inner">
        <h3>{{ total_records_year }}</h3>
        <p><i class="fas fa-clipboard-list mr-1"></i>Tổng bản ghi năm</p>
        <small>
          <i class="fas fa-check-circle text-success mr-1"></i>{{ completed_year or 0 }} hoàn thành
          <span class="mx-1">|</span>
          <i class="fas fa-spinner text-warning mr-1"></i>{{ in_progress_year or 0 }} đang thực hiện
          <span class="mx-1">|</span>
          <i class="fas fa-times-circle text-danger mr-1"></i>{{ cancelled_year or 0 }} đã hủy
        </small>
      </div>
      <div class="icon"><i class="fas fa-tools"></i></div>
      <a href="{{ url_for('maintenance_list', year=year) }}" class="small-box-footer">
        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
      </a>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="small-box bg-success">
      <div class="inner">
        <h3>{{ '{:,.0f}'.format(total_cost_year or 0) }}<small> VNĐ</small></h3>
        <p><i class="fas fa-money-bill-wave mr-1"></i>Tổng chi phí năm</p>
        <small>
          <i class="fas fa-file-invoice-dollar mr-1"></i>{{ records_with_cost_year or 0 }} bản ghi có chi phí
          {% if max_cost_year > 0 %}
          <span class="mx-1">|</span>
          <i class="fas fa-arrow-up text-success mr-1"></i>Cao nhất: {{ '{:,.0f}'.format(max_cost_year) }} VNĐ
          {% endif %}
        </small>
      </div>
      <div class="icon"><i class="fas fa-donate"></i></div>
      <a href="{{ url_for('maintenance_list', year=year, has_cost=1) }}" class="small-box-footer">
        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
      </a>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="small-box bg-gradient-primary">
      <div class="inner">
        <h3>{{ completion_rate }}<small>%</small></h3>
        <p><i class="fas fa-check-circle mr-1"></i>Tỷ lệ hoàn thành</p>
        <small>
          <i class="fas fa-check text-success mr-1"></i>{{ completed_year or 0 }} hoàn thành
          <span class="mx-1">|</span>
          <i class="fas fa-clock text-warning mr-1"></i>{{ scheduled_year or 0 }} đã lên lịch
          <span class="mx-1">|</span>
          <i class="fas fa-cog text-info mr-1"></i>{{ in_progress_year or 0 }} đang thực hiện
        </small>
      </div>
      <div class="icon"><i class="fas fa-chart-pie"></i></div>
      <a href="{{ url_for('maintenance_list', year=year, status='completed') }}" class="small-box-footer">
        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
      </a>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="small-box bg-gradient-info">
      <div class="inner">
        <h3>{{ '{:,.0f}'.format(avg_cost_per_record or 0) }}<small> VNĐ</small></h3>
        <p><i class="fas fa-calculator mr-1"></i>Chi phí trung bình</p>
        <small>
          <i class="fas fa-chart-line mr-1"></i>Trên {{ records_with_cost_year or 0 }} bản ghi có chi phí
          {% if max_cost_year > 0 and min_cost_year > 0 %}
          <span class="mx-1">|</span>
          <i class="fas fa-arrow-down text-info mr-1"></i>Thấp nhất: {{ '{:,.0f}'.format(min_cost_year) }} VNĐ
          {% endif %}
        </small>
      </div>
      <div class="icon"><i class="fas fa-balance-scale"></i></div>
      <a href="{{ url_for('maintenance_list', year=year, has_cost=1) }}" class="small-box-footer">
        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
      </a>
    </div>
  </div>
</div>

<!-- KPI Cards Row 2: Thống kê tháng và cảnh báo -->
<div class="row mb-3">
  <div class="col-12">
    <h5 class="mb-2"><i class="fas fa-calendar-check text-success mr-2"></i>Thống kê tháng {{ month }}/{{ year }}</h5>
  </div>
</div>
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="small-box bg-gradient-success">
      <div class="inner">
        <h3>{{ total_records_month }}</h3>
        <p><i class="fas fa-list-alt mr-1"></i>Bản ghi tháng này</p>
        <small>
          <i class="fas fa-calendar-alt mr-1"></i>Tháng {{ month }}/{{ year }}
          <span class="mx-1">|</span>
          <i class="fas fa-check text-success mr-1"></i>{{ completed_month or 0 }} hoàn thành
          <span class="mx-1">|</span>
          <i class="fas fa-spinner text-warning mr-1"></i>{{ in_progress_month or 0 }} đang thực hiện
        </small>
      </div>
      <div class="icon"><i class="fas fa-calendar-day"></i></div>
      <a href="{{ url_for('maintenance_list', month=month, year=year) }}" class="small-box-footer">
        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
      </a>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="small-box bg-gradient-warning">
      <div class="inner">
        <h3>{{ '{:,.0f}'.format(total_cost_month or 0) }}<small> VNĐ</small></h3>
        <p><i class="fas fa-coins mr-1"></i>Chi phí tháng này</p>
        <small>
          <i class="fas fa-file-invoice-dollar mr-1"></i>{{ records_with_cost_month or 0 }} bản ghi có chi phí
          {% if max_cost_month > 0 %}
          <span class="mx-1">|</span>
          <i class="fas fa-arrow-up text-success mr-1"></i>Cao nhất: {{ '{:,.0f}'.format(max_cost_month) }} VNĐ
          {% endif %}
        </small>
      </div>
      <div class="icon"><i class="fas fa-wallet"></i></div>
      <a href="{{ url_for('maintenance_list', month=month, year=year, has_cost=1) }}" class="small-box-footer">
        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
      </a>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="small-box bg-danger">
      <div class="inner">
        <h3>{{ overdue }}</h3>
        <p><i class="fas fa-exclamation-triangle mr-1"></i>Bảo trì quá hạn</p>
        <small>
          <i class="fas fa-exclamation-circle mr-1"></i>Cần xử lý ngay
          {% if overdue > 0 %}
          <span class="mx-1">|</span>
          <i class="fas fa-calendar-times mr-1"></i>Đã quá hạn
          <span class="mx-1">|</span>
          <i class="fas fa-tools mr-1"></i>Ưu tiên cao
          {% else %}
          <span class="mx-1">|</span>
          <i class="fas fa-check-circle text-success mr-1"></i>Không có bản ghi quá hạn
          {% endif %}
        </small>
      </div>
      <div class="icon"><i class="fas fa-exclamation-circle"></i></div>
      <a href="{{ url_for('maintenance_list', overdue=1) }}" class="small-box-footer">
        Xem danh sách <i class="fas fa-arrow-circle-right"></i>
      </a>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-6">
    <div class="small-box bg-warning">
      <div class="inner">
        <h3>{{ due_30 }}</h3>
        <p><i class="fas fa-hourglass-half mr-1"></i>Sắp đến hạn</p>
        <small>
          <i class="fas fa-calendar-check mr-1"></i>Trong 30 ngày tới
          {% if due_30 > 0 %}
          <span class="mx-1">|</span>
          <i class="fas fa-bell mr-1"></i>Cần chuẩn bị
          <span class="mx-1">|</span>
          <i class="fas fa-clock text-warning mr-1"></i>Chuẩn bị lên lịch
          {% else %}
          <span class="mx-1">|</span>
          <i class="fas fa-check-circle text-success mr-1"></i>Không có bản ghi sắp đến hạn
          {% endif %}
        </small>
      </div>
      <div class="icon"><i class="fas fa-clock"></i></div>
      <a href="{{ url_for('maintenance_list', due_30=1) }}" class="small-box-footer">
        Xem danh sách <i class="fas fa-arrow-circle-right"></i>
      </a>
    </div>
  </div>
</div>

{# Section "Thông tin bổ sung" đã được yêu cầu ẩn/xóa #}

<!-- Tables Section -->
<div class="row">
  <!-- Bản ghi quá hạn -->
  <div class="col-md-6">
    <div class="card card-danger card-outline card-bg-overdue">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          Bản ghi QUÁ HẠN
          {% if overdue > 0 %}
          <span class="badge badge-danger ml-2">{{ overdue }}</span>
          {% endif %}
        </h3>
        <div class="card-tools">
          <a href="{{ url_for('maintenance_list', overdue=1) }}" class="btn btn-sm btn-danger">
            Xem tất cả <i class="fas fa-external-link-alt"></i>
          </a>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="thead-dark">
              <tr>
                <th style="width: 15%;">Ngày hết hạn</th>
                <th style="width: 25%;">Thiết bị</th>
                <th style="width: 15%;">Loại</th>
                <th style="width: 20%;">Người phụ trách</th>
                <th style="width: 15%;">Trạng thái</th>
                <th style="width: 10%;">Chi phí</th>
              </tr>
            </thead>
            <tbody>
              {% if overdue_records %}
                {% for r in overdue_records %}
                <tr>
                  <td>
                    <a href="{{ url_for('maintenance_view', id=r.id) }}" class="font-weight-bold text-danger">
                      {{ r.next_due_date|vn_date }}
                    </a>
                    <br><small class="text-muted">
                      {% set days_overdue = (today - r.next_due_date).days %}
                      Quá {{ days_overdue }} ngày
                    </small>
                  </td>
                  <td>
                    <a href="{{ url_for('maintenance_view', id=r.id) }}">
                      <strong>#{{ r.asset_id }}</strong><br>
                      <small>{{ r.asset.name }}</small>
                    </a>
                  </td>
                  <td>
                    <span class="badge badge-info">{{ r.type|maintenance_type_vi }}</span>
                  </td>
                  <td>{{ r.person_in_charge or '-' }}</td>
                  <td>
                    <span class="badge badge-danger">{{ r.status | maintenance_status_vi }}</span>
                  </td>
                  <td>
                    <strong>{{ '{:,.0f}'.format(r.cost or 0) }}</strong>
                    <small class="d-block text-muted">VNĐ</small>
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i><br>
                    Không có bản ghi quá hạn
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sắp đến hạn 30 ngày -->
  <div class="col-md-6">
    <div class="card card-warning card-outline card-bg-upcoming">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-hourglass-half mr-2"></i>
          Sắp đến hạn 30 ngày
          {% if due_30 > 0 %}
          <span class="badge badge-warning ml-2">{{ due_30 }}</span>
          {% endif %}
        </h3>
        <div class="card-tools">
          <a href="{{ url_for('maintenance_list', due_30=1) }}" class="btn btn-sm btn-warning">
            Xem tất cả <i class="fas fa-external-link-alt"></i>
          </a>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="thead-warning">
              <tr>
                <th style="width: 15%;">Ngày đến hạn</th>
                <th style="width: 25%;">Thiết bị</th>
                <th style="width: 15%;">Loại</th>
                <th style="width: 20%;">Người phụ trách</th>
                <th style="width: 15%;">Trạng thái</th>
                <th style="width: 10%;">Chi phí</th>
              </tr>
            </thead>
            <tbody>
              {% if upcoming %}
                {% for r in upcoming %}
                <tr>
                  <td>
                    <a href="{{ url_for('maintenance_view', id=r.id) }}" class="font-weight-bold">
                      {{ r.next_due_date|vn_date }}
                    </a>
                    <br><small class="text-muted">
                      {% set days_left = (r.next_due_date - today).days %}
                      Còn {{ days_left }} ngày
                    </small>
                  </td>
                  <td>
                    <a href="{{ url_for('maintenance_view', id=r.id) }}">
                      <strong>#{{ r.asset_id }}</strong><br>
                      <small>{{ r.asset.name }}</small>
                    </a>
                  </td>
                  <td>
                    <span class="badge badge-info">{{ r.type|maintenance_type_vi }}</span>
                  </td>
                  <td>{{ r.person_in_charge or '-' }}</td>
                  <td>
                    <span class="badge badge-warning">{{ r.status | maintenance_status_vi }}</span>
                  </td>
                  <td>
                    <strong>{{ '{:,.0f}'.format(r.cost or 0) }}</strong>
                    <small class="d-block text-muted">VNĐ</small>
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i><br>
                    Không có bản ghi đến hạn trong 30 ngày
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
